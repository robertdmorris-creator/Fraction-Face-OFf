<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fraction Face-off</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700&family=Lilita+One&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #1a202c;
            background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #4a5568;
            overflow: hidden;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .font-lilita {
            font-family: 'Lilita One', cursive;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 1.5rem;
            border: 4px solid white;
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        .question-card {
            background-color: rgba(255, 255, 255, 0.98);
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-color: #c4b5fd;
            text-align: center;
        }
        .choice-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            min-height: 200px;
            padding: 1rem;
            position: relative;
        }
        @media (min-width: 1024px) {
            .choice-card {
                min-height: 250px;
                padding: 1.5rem;
            }
        }
        .choice-card.correct { border-color: #34d399; background-color: rgba(236, 252, 241, 0.95); }
        .choice-card.incorrect { border-color: #fb7185; background-color: rgba(255, 237, 240, 0.95); }
        .choice-card.drop-zone-active { border-color: #f59e0b; transform: scale(1.02); }
        
        .team-token-disc {
            width: 50px;
            height: 50px;
            border-radius: 9999px;
            cursor: grab;
            transition: all 0.2s ease;
            border: 3px solid white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            touch-action: none;
            z-index: 50; /* High z-index to be seen while dragging */
        }
        @media (min-width: 1024px) {
            .team-token-disc {
                width: 60px;
                height: 60px;
                border-width: 4px;
            }
        }
        .team-token-disc:active { cursor: grabbing; transform: scale(1.1); z-index: 100; }
        .team-token-disc.placed {
            width: 40px;
            height: 40px;
            border-width: 3px;
            display: block !important; /* Force show when revealed */
        }
        
        .team-token-disc.hidden-token {
            display: none !important;
        }

        /* Timer pulse animation */
        @keyframes pulse-red {
            0%, 100% { color: #fecaca; }
            50% { color: #ef4444; }
        }
        .timer-low {
            animation: pulse-red 1s infinite;
            font-weight: 800;
        }

        .token-start-zone {
            min-height: 70px;
            width: 100%;
            border: 2px dashed #a0aec0;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255,255,255,0.2);
            position: relative;
        }
        
        .token-drop-container {
            width: 100%;
            min-height: 60px;
            background-color: rgba(0,0,0,0.03);
            border-radius: 0.75rem;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.5rem;
        }

        .btn {
            border-radius: 0.75rem;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 2px solid transparent;
        }
        .btn-primary { background-color: #fb7185; color: white; }
        .btn-primary:hover { background-color: #f43f5e; }
        .btn-green { background-color: #34d399; color: white; }
        .btn-green:hover { background-color: #10b981; }
        .btn-yellow { background-color: #f59e0b; color: white; }
        .btn-yellow:hover { background-color: #ea580c; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .emoji-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        .emoji-bg span {
            position: absolute;
            font-size: 2rem;
            animation: float 20s infinite linear;
            opacity: 0.3;
        }

        @keyframes float {
            0% { transform: translateY(100vh) rotate(0deg); }
            100% { transform: translateY(-10vh) rotate(360deg); }
        }

        /* Fraction CSS */
        .fraction {
            display: inline-flex;
            align-items: center;
            font-family: 'Lilita One', cursive;
            color: #4338ca; 
        }
        .fraction-whole {
            font-size: 1.2em;
            margin-right: 0.2rem;
        }
        .fraction-part {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            vertical-align: middle;
            font-size: 0.8em;
        }
        .fraction-num {
            border-bottom: 3px solid currentColor;
            padding: 0 0.2rem;
            line-height: 1;
        }
        .fraction-den {
            padding: 0 0.2rem;
            line-height: 1;
        }
        .operator {
            margin: 0 0.5rem;
            font-size: 1.2em;
            color: #4a5568;
        }
        
        /* Inline fraction for word problems */
        .fraction-inline {
            display: inline-flex;
            vertical-align: middle;
            font-size: 1.1em;
            margin: 0 0.2em;
        }
        .fraction-inline .fraction-whole {
            font-size: 1em;
            margin-right: 0.1em;
        }
        .fraction-inline .fraction-part {
            font-size: 0.7em;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-2 lg:p-4">

    <div class="emoji-bg" id="emoji-background"></div>

    <div class="w-full max-w-6xl mx-auto text-center relative z-10 flex flex-col h-full">
        <button id="fullscreen-btn" class="absolute top-0 right-0 z-50 p-2 rounded-full bg-white/30 hover:bg-white/50 text-white" title="Toggle Fullscreen">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
            </svg>
        </button>

        <!-- Setup Section -->
        <div id="setup-section" class="card p-8 lg:p-12 mb-8 mt-4 mx-auto w-full max-w-4xl">
            <h1 class="text-6xl lg:text-8xl font-lilita text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-indigo-500 tracking-wider">Fraction Face-off</h1>
            <h2 class="text-xl lg:text-2xl mt-2 mb-6 text-slate-500">Mixed Number Mayhem!</h2>
            <h3 class="text-lg lg:text-xl font-semibold mb-4 text-gray-700">How many teams are playing?</h3>
            <div id="team-count-selector" class="flex justify-center space-x-4 mb-6">
                <button data-count="2" class="btn bg-slate-200 hover:bg-slate-300 text-slate-700 w-16 h-16 lg:w-20 lg:h-20 text-3xl rounded-full">2</button>
                <button data-count="3" class="btn bg-slate-200 hover:bg-slate-300 text-slate-700 w-16 h-16 lg:w-20 lg:h-20 text-3xl rounded-full">3</button>
                <button data-count="4" class="btn bg-slate-200 hover:bg-slate-300 text-slate-700 w-16 h-16 lg:w-20 lg:h-20 text-3xl rounded-full">4</button>
            </div>
            <div id="team-config-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>
            <button id="start-game-btn" class="btn btn-primary text-xl lg:text-2xl hidden w-full md:w-auto transform hover:scale-105">Start Game</button>
        </div>

        <!-- Game Section -->
        <div id="game-section" class="hidden w-full flex-grow flex flex-col">
            <!-- Top Controls -->
            <div class="flex justify-between items-center mb-2 px-2">
                 <div class="flex items-center gap-4">
                     <div class="text-white font-lilita text-xl tracking-wider">Question <span id="q-number">1</span>/30</div>
                     <!-- Timer Display -->
                     <div id="timer-display" class="bg-white/20 backdrop-blur-sm border-2 border-white/50 rounded-lg px-4 py-1 text-white font-lilita text-2xl tracking-widest shadow-lg">03:00</div>
                 </div>
                <div>
                    <button id="reveal-btn" class="btn btn-yellow text-lg lg:text-xl shadow-lg">Reveal</button>
                    <button id="next-btn" class="btn btn-green text-lg lg:text-xl shadow-lg hidden">Next</button>
                </div>
            </div>
            
            <!-- Question Area -->
            <div id="question-area" class="card question-card mb-4 lg:mb-6 shadow-xl p-4">
                <!-- Question injected here -->
            </div>

            <!-- Answer Choices (Grid of 3) -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 lg:gap-6 mb-4 lg:mb-6">
                
                <!-- Choice 0 -->
                <div id="choice-0" class="card choice-card group">
                    <div class="text-slate-400 font-bold text-sm absolute top-2 left-3">Option A</div>
                    <div class="flex-grow flex items-center justify-center transform group-hover:scale-110 transition-transform duration-300">
                        <div id="value-0" class="text-4xl lg:text-6xl"></div>
                    </div>
                    <div class="token-drop-container"></div>
                </div>

                <!-- Choice 1 -->
                <div id="choice-1" class="card choice-card group">
                    <div class="text-slate-400 font-bold text-sm absolute top-2 left-3">Option B</div>
                    <div class="flex-grow flex items-center justify-center transform group-hover:scale-110 transition-transform duration-300">
                        <div id="value-1" class="text-4xl lg:text-6xl"></div>
                    </div>
                    <div class="token-drop-container"></div>
                </div>

                <!-- Choice 2 -->
                <div id="choice-2" class="card choice-card group">
                    <div class="text-slate-400 font-bold text-sm absolute top-2 left-3">Option C</div>
                    <div class="flex-grow flex items-center justify-center transform group-hover:scale-110 transition-transform duration-300">
                        <div id="value-2" class="text-4xl lg:text-6xl"></div>
                    </div>
                    <div class="token-drop-container"></div>
                </div>

            </div>

            <!-- Team Controls -->
            <div id="teams-control-area" class="grid grid-cols-2 md:grid-cols-4 gap-3 lg:gap-4 mt-auto">
                <!-- Team controls are generated here -->
            </div>
            
            <!-- Feedback -->
            <p id="feedback-text" class="text-2xl lg:text-3xl font-bold mt-4 h-8 text-white drop-shadow-md"></p>
        </div>
    </div>

    <script>
        // --- Fraction Class & Math Logic ---
        function gcd(a, b) { return b === 0 ? a : gcd(b, a % b); }
        function lcm(a, b) { return (a * b) / gcd(a, b); }

        class Fraction {
            constructor(w, n, d) {
                this.w = w || 0; // whole
                this.n = n || 0; // numerator
                this.d = d || 1; // denominator
                this.normalize();
            }

            normalize() {
                if (this.d === 0) throw new Error("Divide by zero");
                if (this.n >= this.d) {
                    this.w += Math.floor(this.n / this.d);
                    this.n = this.n % this.d;
                }
                if (this.n < 0) {
                    while(this.n < 0 && this.w > 0) {
                        this.w--;
                        this.n += this.d;
                    }
                }
                const common = gcd(this.n, this.d);
                this.n /= common;
                this.d /= common;
            }

            toImproper() {
                return { n: this.w * this.d + this.n, d: this.d };
            }

            static fromImproper(n, d) {
                return new Fraction(0, n, d);
            }

            add(other) {
                const f1 = this.toImproper();
                const f2 = other.toImproper();
                const commonDenom = lcm(f1.d, f2.d);
                const newNum = f1.n * (commonDenom / f1.d) + f2.n * (commonDenom / f2.d);
                return Fraction.fromImproper(newNum, commonDenom);
            }

            sub(other) {
                const f1 = this.toImproper();
                const f2 = other.toImproper();
                const commonDenom = lcm(f1.d, f2.d);
                let newNum = f1.n * (commonDenom / f1.d) - f2.n * (commonDenom / f2.d);
                if (newNum < 0) newNum = 0; 
                return Fraction.fromImproper(newNum, commonDenom);
            }

            isEqual(other) {
                return this.w === other.w && this.n === other.n && this.d === other.d;
            }

            toString() {
                if (this.w > 0 && this.n > 0) return `${this.w} ${this.n}/${this.d}`;
                if (this.w > 0) return `${this.w}`;
                return `${this.n}/${this.d}`;
            }

            render(sizeClass = 'text-4xl lg:text-6xl') {
                let html = `<div class="fraction ${sizeClass}">`;
                if (this.w > 0) {
                    html += `<span class="fraction-whole">${this.w}</span>`;
                } else if (this.n === 0) {
                    return `<div class="fraction ${sizeClass}"><span class="fraction-whole">0</span></div>`;
                }
                
                if (this.n > 0) {
                    html += `
                        <div class="fraction-part">
                            <span class="fraction-num">${this.n}</span>
                            <span class="fraction-den">${this.d}</span>
                        </div>
                    `;
                }
                html += `</div>`;
                return html;
            }

            renderInline() {
                 return this.render('fraction-inline');
            }
        }

        // --- DOM Elements ---
        const setupSection = document.getElementById('setup-section');
        const teamCountSelector = document.getElementById('team-count-selector');
        const teamConfigContainer = document.getElementById('team-config-container');
        const startGameBtn = document.getElementById('start-game-btn');
        const gameSection = document.getElementById('game-section');
        const questionArea = document.getElementById('question-area');
        const teamsControlArea = document.getElementById('teams-control-area');
        const feedbackText = document.getElementById('feedback-text');
        const revealBtn = document.getElementById('reveal-btn');
        const nextBtn = document.getElementById('next-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const emojiBackground = document.getElementById('emoji-background');
        const qNumberSpan = document.getElementById('q-number');
        const timerDisplay = document.getElementById('timer-display');

        // Choice Elements
        const choices = [
            { card: document.getElementById('choice-0'), val: document.getElementById('value-0') },
            { card: document.getElementById('choice-1'), val: document.getElementById('value-1') },
            { card: document.getElementById('choice-2'), val: document.getElementById('value-2') }
        ];

        // --- Game State ---
        let teams = [];
        let isAnswered = false;
        let draggedItem = null;
        let questionDeck = [];
        let currentQuestionIndex = 0;
        let currentQuestion = null; 
        
        // --- Timer State ---
        let timerInterval = null;
        let timeLeft = 180; // 3 minutes in seconds
        let isTimeUp = false;

        // --- Setup Logic ---
        const defaultColors = ['#f43f5e', '#10b981', '#f59e0b', '#3b82f6'];

        teamCountSelector.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const count = parseInt(e.target.dataset.count);
                createTeamConfigs(count);
                document.querySelectorAll('#team-count-selector button').forEach(btn => {
                    btn.classList.remove('bg-indigo-500', 'text-white');
                    btn.classList.add('bg-slate-200', 'text-slate-700');
                });
                e.target.classList.add('bg-indigo-500', 'text-white');
                e.target.classList.remove('bg-slate-200', 'text-slate-700');
            }
        });

        // Initialize immediately with 2 teams
        (function initSetup() {
            const defaultCount = 2;
            createTeamConfigs(defaultCount);
            const defaultBtn = document.querySelector(`button[data-count="${defaultCount}"]`);
            if (defaultBtn) {
                defaultBtn.classList.remove('bg-slate-200', 'text-slate-700');
                defaultBtn.classList.add('bg-indigo-500', 'text-white');
            }
        })();

        function createTeamConfigs(count) {
            teamConfigContainer.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const teamConfig = document.createElement('div');
                teamConfig.className = 'flex flex-col items-center space-y-2 p-3 bg-white/20 rounded-lg';
                teamConfig.innerHTML = `
                    <label for="team-name-${i}" class="font-semibold text-white">Team ${i + 1}</label>
                    <input type="text" id="team-name-${i}" class="w-full bg-white/50 border border-slate-300 rounded-md p-2 text-slate-700 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="Name" value="Team ${i+1}">
                    <input type="color" id="team-color-${i}" value="${defaultColors[i]}" class="w-full h-10 rounded-md cursor-pointer bg-transparent border-0">
                `;
                teamConfigContainer.appendChild(teamConfig);
            }
            startGameBtn.classList.remove('hidden');
        }

        startGameBtn.addEventListener('click', () => {
            teams = [];
            const configs = teamConfigContainer.querySelectorAll('div');
            configs.forEach((config, i) => {
                const name = config.querySelector(`#team-name-${i}`).value || `Team ${i+1}`;
                const color = config.querySelector(`#team-color-${i}`).value;
                teams.push({ id: i, name, color, score: 0, choice: null, choiceTimestamp: null });
            });
            setupSection.classList.add('hidden');
            gameSection.classList.remove('hidden');
            generateQuestionDeck();
            initializeGame();
        });
        
        // --- Emoji Background ---
        function createFloatingEmojis() {
            const emojis = ['½', '⅓', '¼', '¾', '⅕', '+', '-', '='];
            for (let i = 0; i < 20; i++) {
                const emoji = document.createElement('span');
                emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                emoji.style.left = `${Math.random() * 100}vw`;
                emoji.style.animationDuration = `${Math.random() * 15 + 10}s`;
                emoji.style.animationDelay = `${Math.random() * 10}s`;
                emoji.style.fontSize = `${Math.random() * 3 + 2}rem`;
                emoji.style.color = 'rgba(255,255,255,0.2)';
                emojiBackground.appendChild(emoji);
            }
        }
        createFloatingEmojis();

        // --- Audio Logic ---
        function playAlarm() {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                osc.type = 'square';
                osc.frequency.setValueAtTime(440, ctx.currentTime);
                osc.frequency.setValueAtTime(330, ctx.currentTime + 0.2);
                osc.frequency.setValueAtTime(440, ctx.currentTime + 0.4);
                
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.8);
                
                osc.start();
                osc.stop(ctx.currentTime + 0.8);
            } catch (e) {
                console.log('Audio error:', e);
            }
        }

        // --- Timer Logic ---
        function updateTimerDisplay() {
            const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const s = (timeLeft % 60).toString().padStart(2, '0');
            timerDisplay.textContent = `${m}:${s}`;
            
            if (timeLeft <= 10) {
                timerDisplay.classList.add('timer-low');
            } else {
                timerDisplay.classList.remove('timer-low');
            }
        }

        function startTimer() {
            clearInterval(timerInterval);
            timeLeft = 180; // 3 minutes
            isTimeUp = false;
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                if (timeLeft > 0) {
                    timeLeft--;
                    updateTimerDisplay();
                } else {
                    stopTimer();
                    isTimeUp = true;
                    playAlarm();
                    // Lock interactions automatically via isTimeUp flag checks in handlers
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        // --- Question Generation Logic ---
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function generateMixedFraction(simpleMode = false) {
            // Updated for bigger fractions, but allows simple mode for word problems
            const w = Math.random() < 0.2 ? 0 : getRandomInt(1, 12);
            let dens;
            if (simpleMode) {
                dens = [2, 3, 4, 5, 6, 8]; // Under 9
            } else {
                dens = [2, 3, 4, 5, 6, 8, 9, 10, 12, 15, 16, 20];
            }
            const d = dens[Math.floor(Math.random() * dens.length)];
            const n = getRandomInt(1, d - 1);
            return new Fraction(w, n, d);
        }

        function getValidMathComponents(op, simpleMode = false) {
            let f1, f2;
            let safe = 0;
            
            if (op === '+') {
                 // Ensure sum of fractions < 1 to avoid carrying over
                do {
                   f1 = generateMixedFraction(simpleMode);
                   f2 = generateMixedFraction(simpleMode);
                   safe++;
                } while ((f1.n / f1.d) + (f2.n / f2.d) >= 1 && safe < 200);
                if (safe >= 200) { f1 = new Fraction(1, 1, 5); f2 = new Fraction(1, 1, 5); }
            } else {
                 // Subtraction logic
                 f1 = generateMixedFraction(simpleMode);
                 f2 = generateMixedFraction(simpleMode);

                 // Ensure whole numbers are ordered f1 >= f2
                 if (f2.w > f1.w) { [f1, f2] = [f2, f1]; }
                 
                 // Check fractional parts to prevent borrowing
                 const frac1 = f1.n * f2.d;
                 const frac2 = f2.n * f1.d;

                 if (frac2 > frac1) {
                     const tempN = f1.n; const tempD = f1.d;
                     f1.n = f2.n; f1.d = f2.d;
                     f2.n = tempN; f2.d = tempD;
                 }

                 if (f1.w === f2.w && f1.n === f2.n && f1.d === f2.d) {
                     f1.w += 1;
                 }
            }
            return { f1, f2 };
        }

        function getValidWordProblemComponents() {
            // Specialized generator that ensures BOTH Add (No Carry) AND Sub (No Borrow)
            // This guarantees the inverse operation distractor is also solvable without complex regrouping.
            let f1, f2;
            let safe = 0;
            do {
                f1 = generateMixedFraction(true); // Simple fractions
                f2 = generateMixedFraction(true);
                
                // Ensure f1 >= f2 for subtraction safety base
                if ((f1.w + f1.n/f1.d) < (f2.w + f2.n/f2.d)) {
                    [f1, f2] = [f2, f1];
                }

                // Check Addition Safety (No carry over)
                const sumFrac = (f1.n * f2.d + f2.n * f1.d) / (f1.d * f2.d);
                const addSafe = sumFrac < 1;

                // Check Subtraction Safety (No borrowing)
                // Since f1 >= f2 overall, we just need to make sure f1's fraction >= f2's fraction
                // Cross multiply: n1/d1 >= n2/d2  => n1*d2 >= n2*d1
                const subSafe = (f1.n * f2.d) >= (f2.n * f1.d);

                if (addSafe && subSafe) return { f1, f2 };

                safe++;
            } while (safe < 500);
            
            // Fallback if random gen fails often
            return { f1: new Fraction(2, 2, 3), f2: new Fraction(1, 1, 3) };
        }

        function generateQuestionDeck() {
            questionDeck = [];
            const usedSignatures = new Set();
            
            // Uniqueness Check Helper
            function isUnique(f1, f2, op) {
                const sig = `${f1.toString()}${op}${f2.toString()}`;
                if (usedSignatures.has(sig)) return false;
                usedSignatures.add(sig);
                return true;
            }
            
            // 1. 7 Unique Word Problems
            const names = ["Sam", "Alex", "Jo", "Pat", "Kim", "Mia", "Leo", "Max", "Ivy", "Ben"];
            const scenarios = [
                { unit: "miles", verb: "ran" },
                { unit: "cups of flour", verb: "used" },
                { unit: "hours", verb: "studied" },
                { unit: "pounds of apples", verb: "picked" },
                { unit: "gallons of water", verb: "drank" },
                { unit: "inches", verb: "grew" }
            ];

            let wpCount = 0;
            while(wpCount < 7) {
                const op = Math.random() > 0.5 ? '+' : '-';
                // Use strict generator for word problems
                const { f1, f2 } = getValidWordProblemComponents();
                
                if (!isUnique(f1, f2, op)) continue;

                const name1 = names[getRandomInt(0, names.length-1)];
                let name2 = names[getRandomInt(0, names.length-1)];
                while(name1 === name2) name2 = names[getRandomInt(0, names.length-1)];
                
                const scenario = scenarios[getRandomInt(0, scenarios.length-1)];
                let text = "";

                if (op === '+') {
                    text = `${name1} ${scenario.verb} ${f1.renderInline()} ${scenario.unit}. ${name2} ${scenario.verb} ${f2.renderInline()} ${scenario.unit}. How many ${scenario.unit} did they ${scenario.verb} in total?`;
                } else {
                    text = `${name1} ${scenario.verb} ${f1.renderInline()} ${scenario.unit}. ${name2} ${scenario.verb} ${f2.renderInline()} ${scenario.unit}. How many more ${scenario.unit} did ${name1} ${scenario.verb}?`;
                }

                questionDeck.push({
                    type: 'word',
                    text: text,
                    f1: f1,
                    f2: f2,
                    op: op
                });
                wpCount++;
            }

            // 2. 23 Unique Random Mixed Fraction Questions (Standard Mode)
            let eqCount = 0;
            while(eqCount < 23) {
                const op = Math.random() > 0.5 ? '+' : '-';
                const { f1, f2 } = getValidMathComponents(op, false); // False = Allow large fractions
                
                if (!isUnique(f1, f2, op)) continue;
                
                questionDeck.push({
                    type: 'random',
                    f1: f1,
                    f2: f2,
                    op: op
                });
                eqCount++;
            }

            // Shuffle
            for (let i = questionDeck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [questionDeck[i], questionDeck[j]] = [questionDeck[j], questionDeck[i]];
            }
            currentQuestionIndex = 0;
        }

        // --- Game Logic ---
        function initializeGame() {
            createTeamControls();
            loadNextQuestion();
            addInteractionListeners();
        }

        // Global function for undoing choice
        window.undoChoice = function(teamId) {
            if (isAnswered) return; // Can't undo after reveal
            if (isTimeUp) return; // Can't undo if time is up

            const team = teams.find(t => t.id === teamId);
            if (!team || team.choice === null) return;

            const token = document.getElementById(`team-token-${teamId}`);
            const startZone = document.getElementById(`token-start-zone-${teamId}`);
            const badge = document.getElementById(`status-badge-${teamId}`);

            // Reset state
            team.choice = null;
            team.choiceTimestamp = null;

            // Reset UI
            token.classList.remove('hidden-token', 'placed');
            token.style.display = '';
            startZone.appendChild(token);
            badge.classList.add('hidden');
        };

        function createTeamControls() {
            teamsControlArea.innerHTML = '';
            teams.forEach(team => {
                const teamControl = document.createElement('div');
                teamControl.id = `team-control-${team.id}`;
                teamControl.className = 'card p-3 lg:p-4 flex flex-col items-center justify-between space-y-2';
                teamControl.innerHTML = `
                    <div class="relative w-full h-[70px]">
                        <div id="token-start-zone-${team.id}" class="token-start-zone w-full h-full absolute top-0 left-0 z-10">
                             <div id="team-token-${team.id}" class="team-token-disc" draggable="true" style="background-color: ${team.color};"></div>
                        </div>
                        <div id="status-badge-${team.id}" class="hidden absolute top-0 left-0 w-full h-full flex items-center justify-center bg-gray-100/50 border-2 border-dashed border-gray-300 rounded-xl cursor-pointer z-20" onclick="undoChoice(${team.id})">
                            <div class="text-center leading-tight">
                                <span class="font-bold text-green-600">Ready!</span><br>
                                <span class="text-xs text-gray-500 font-bold">Tap to undo</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-center w-full mt-2">
                        <div class="flex justify-between items-center w-full px-2">
                             <p class="font-bold truncate" style="color: ${team.color};">${team.name}</p>
                             <p id="team-score-${team.id}" class="text-2xl font-lilita text-slate-600">${team.score}</p>
                        </div>
                    </div>
                `;
                teamsControlArea.appendChild(teamControl);
            });
        }

        function loadNextQuestion() {
            isAnswered = false;
            feedbackText.textContent = '';
            feedbackText.classList.remove('text-yellow-300', 'text-red-400');
            nextBtn.classList.add('hidden');
            revealBtn.classList.remove('hidden');
            revealBtn.disabled = false;
            
            // Reset Timer
            startTimer();
            
            teams.forEach(t => { t.choice = null; t.choiceTimestamp = null; });
            choices.forEach(c => {
                c.card.classList.remove('correct', 'incorrect');
                c.val.innerHTML = ''; 
            });

            if (currentQuestionIndex >= questionDeck.length) {
                generateQuestionDeck();
            }
            const qData = questionDeck[currentQuestionIndex];
            currentQuestionIndex++;
            qNumberSpan.textContent = currentQuestionIndex;

            let result;
            if (qData.op === '+') result = qData.f1.add(qData.f2);
            else result = qData.f1.sub(qData.f2);

            let distractors = [];
            
            // Smart Distractor Logic for Word Problems
            // Add the answer for the INVERSE operation as a choice
            if (qData.type === 'word') {
                let inverseRes;
                if (qData.op === '+') {
                    // Distractor is subtraction
                    inverseRes = qData.f1.sub(qData.f2);
                } else {
                    // Distractor is addition
                    inverseRes = qData.f1.add(qData.f2);
                }
                
                if (!inverseRes.isEqual(result)) {
                    distractors.push(inverseRes);
                }
            }

            // Fill remaining distractors
            while(distractors.length < 2) {
                const method = Math.random();
                let d;
                if (method < 0.33) {
                    d = result.add(new Fraction(0, 1, result.d));
                } else if (method < 0.66 && result.w > 0) {
                     d = new Fraction(result.w - 1, result.n, result.d);
                } else {
                    d = generateMixedFraction();
                }

                if (!d.isEqual(result) && !distractors.some(dis => dis.isEqual(d))) {
                    distractors.push(d);
                }
            }

            const answerOptions = [result, ...distractors];
            for (let i = answerOptions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [answerOptions[i], answerOptions[j]] = [answerOptions[j], answerOptions[i]];
            }

            currentQuestion = {
                ...qData,
                correctResult: result,
                options: answerOptions,
                correctIndex: answerOptions.findIndex(opt => opt.isEqual(result))
            };

            // Render logic
            if (qData.type === 'word') {
                questionArea.innerHTML = `
                    <div class="text-3xl lg:text-5xl font-lilita text-slate-700 leading-snug px-4">
                        ${qData.text}
                    </div>
                `;
            } else {
                questionArea.innerHTML = `
                    <div class="flex items-center justify-center space-x-4 text-5xl lg:text-7xl">
                        ${qData.f1.render()}
                        <span class="operator font-lilita text-slate-500">${qData.op}</span>
                        ${qData.f2.render()}
                        <span class="operator font-lilita text-slate-500">=</span>
                        <span class="font-lilita text-indigo-400">?</span>
                    </div>
                `;
            }

            choices.forEach((c, idx) => {
                c.val.innerHTML = answerOptions[idx].render();
            });

            // Reset tokens & badges
            teams.forEach(team => {
                const token = document.getElementById(`team-token-${team.id}`);
                const startZone = document.getElementById(`token-start-zone-${team.id}`);
                const badge = document.getElementById(`status-badge-${team.id}`);
                
                if (token && startZone) {
                    token.classList.remove('placed', 'hidden-token');
                    token.style.display = ''; // Reset inline style
                    startZone.appendChild(token);
                    token.draggable = true;
                    token.style.opacity = '1';
                }
                if (badge) badge.classList.add('hidden');
            });
        }
        
        function checkAnswers() {
            if (isAnswered) return;
            isAnswered = true;
            revealBtn.disabled = true;
            
            stopTimer(); // Ensure timer stops on reveal

            // Reveal Hidden Tokens!
            teams.forEach(team => {
                if (team.choice !== null) {
                    const token = document.getElementById(`team-token-${team.id}`);
                    const badge = document.getElementById(`status-badge-${team.id}`);
                    token.classList.remove('hidden-token');
                    token.style.display = 'block'; // Make visible
                    token.draggable = false;
                    if (badge) badge.classList.add('hidden'); // Hide badge
                } else {
                     // Disable dragging for undecided tokens too
                     const token = document.getElementById(`team-token-${team.id}`);
                     if (token) token.draggable = false;
                }
            });

            const correctIdx = currentQuestion.correctIndex;
            
            const winningTeams = teams.filter(team => team.choice === correctIdx);
            
            if (winningTeams.length > 0) {
                winningTeams.sort((a, b) => a.choiceTimestamp - b.choiceTimestamp);
                const fastest = winningTeams[0];
                
                winningTeams.forEach(team => team.score++);
                
                if (fastest) {
                    fastest.score++; 
                    feedbackText.innerHTML = `<span style="color:${fastest.color}">${fastest.name}</span> was first! +2 pts`;
                }
            } else {
                 feedbackText.textContent = "Oops! Try again next time.";
                 feedbackText.classList.add('text-red-300');
            }
            
            choices.forEach((c, idx) => {
                if (idx === correctIdx) {
                    c.card.classList.add('correct');
                } else {
                    c.card.classList.add('incorrect');
                }
            });

            updateScores();
            nextBtn.classList.remove('hidden');
            revealBtn.classList.add('hidden');
        }

        function updateScores() {
            teams.forEach(team => {
                document.getElementById(`team-score-${team.id}`).textContent = team.score;
            });
        }
        
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }
        
        // --- Drag & Drop Logic ---
        function handleDrop(token, dropTarget) {
            if (isTimeUp) return; // Prevent moves if time is up
            if (dropTarget.classList.contains('team-token-disc')) return; 
            
            let targetZone = null;
            let choiceIndex = null;

            if (dropTarget.classList.contains('token-start-zone')) {
                targetZone = dropTarget;
            } else if (dropTarget.closest('.token-start-zone')) {
                targetZone = dropTarget.closest('.token-start-zone');
            } else {
                const card = dropTarget.closest('.choice-card');
                if (card) {
                    targetZone = card.querySelector('.token-drop-container');
                    if (card.id === 'choice-0') choiceIndex = 0;
                    if (card.id === 'choice-1') choiceIndex = 1;
                    if (card.id === 'choice-2') choiceIndex = 2;
                }
            }

            if (!targetZone) return;

            const tokenTeamId = parseInt(token.id.split('-')[2]);
            if (targetZone.classList.contains('token-start-zone')) {
                 const zoneTeamId = parseInt(targetZone.id.split('-')[2]);
                 if (tokenTeamId !== zoneTeamId) return; 
            }

            // Move Token
            targetZone.appendChild(token);
            
            const team = teams.find(t => t.id === tokenTeamId);
            if (!team) return;

            if (choiceIndex !== null) {
                // Choice Made: Hide token, Show Badge
                if (team.choice === null) {
                    team.choiceTimestamp = Date.now();
                }
                team.choice = choiceIndex;
                
                token.classList.add('placed', 'hidden-token'); // Hide!
                
                // Show "Ready" badge
                const badge = document.getElementById(`status-badge-${tokenTeamId}`);
                if (badge) badge.classList.remove('hidden');

            } else {
                // Returned to start manually (only possible if visible, which won't happen often now, but good to have)
                team.choice = null;
                team.choiceTimestamp = null; 
                token.classList.remove('placed', 'hidden-token');
                
                const badge = document.getElementById(`status-badge-${tokenTeamId}`);
                if (badge) badge.classList.add('hidden');
            }
            
            // Check if all teams answered
            const allAnswered = teams.every(t => t.choice !== null);
            if (allAnswered) {
                stopTimer();
            }
        }

        function addInteractionListeners() {
            document.body.addEventListener('dragstart', (e) => {
                if (isTimeUp) {
                    e.preventDefault();
                    return;
                }
                if (e.target.classList.contains('team-token-disc')) {
                    draggedItem = e.target;
                    setTimeout(() => { e.target.style.opacity = '0.5'; }, 0);
                }
            });

            document.body.addEventListener('dragend', (e) => {
                if (draggedItem) {
                    draggedItem.style.opacity = '1';
                }
                draggedItem = null;
                document.querySelectorAll('.drop-zone-active').forEach(el => el.classList.remove('drop-zone-active'));
            });

            const zones = [...document.querySelectorAll('.choice-card'), ...document.querySelectorAll('.token-start-zone')];
            
            zones.forEach(zone => {
                zone.addEventListener('dragover', e => e.preventDefault());
                zone.addEventListener('dragenter', e => {
                    e.preventDefault();
                    if (zone.classList.contains('choice-card')) zone.classList.add('drop-zone-active');
                });
                zone.addEventListener('dragleave', e => {
                     if (zone.classList.contains('choice-card')) zone.classList.remove('drop-zone-active');
                });
                zone.addEventListener('drop', e => {
                    e.preventDefault();
                    if (!draggedItem) return;
                    if (zone.classList.contains('choice-card')) zone.classList.remove('drop-zone-active');
                    handleDrop(draggedItem, e.target);
                });
            });

            let touchStartX, touchStartY, originalParent, currentDropZone = null;

            document.body.addEventListener('touchstart', (e) => {
                if (isTimeUp) return;
                if (e.target.classList.contains('team-token-disc')) {
                    draggedItem = e.target;
                    originalParent = draggedItem.parentElement;
                    e.preventDefault(); 
                    
                    const touch = e.touches[0];
                    const rect = draggedItem.getBoundingClientRect();
                    
                    touchStartX = touch.clientX - rect.left;
                    touchStartY = touch.clientY - rect.top;
                    
                    draggedItem.style.position = 'fixed';
                    draggedItem.style.zIndex = '1000';
                    draggedItem.style.opacity = '0.8';
                    draggedItem.style.left = `${touch.clientX - touchStartX}px`;
                    draggedItem.style.top = `${touch.clientY - touchStartY}px`;
                    draggedItem.style.width = '60px'; 
                    draggedItem.style.height = '60px';
                }
            }, { passive: false });

            document.body.addEventListener('touchmove', (e) => {
                if (!draggedItem) return;
                e.preventDefault();
                const touch = e.touches[0];
                
                draggedItem.style.left = `${touch.clientX - touchStartX}px`;
                draggedItem.style.top = `${touch.clientY - touchStartY}px`;
                
                draggedItem.style.display = 'none'; 
                const elementUnder = document.elementFromPoint(touch.clientX, touch.clientY);
                draggedItem.style.display = ''; 

                let potentialDropZone = elementUnder ? elementUnder.closest('.choice-card, .token-start-zone') : null;

                if (currentDropZone && currentDropZone !== potentialDropZone) {
                    currentDropZone.classList.remove('drop-zone-active');
                }
                if (potentialDropZone && potentialDropZone.classList.contains('choice-card')) {
                    potentialDropZone.classList.add('drop-zone-active');
                }
                currentDropZone = potentialDropZone;
            }, { passive: false });

            document.body.addEventListener('touchend', (e) => {
                if (!draggedItem) return;
                
                draggedItem.style.position = '';
                draggedItem.style.zIndex = '';
                draggedItem.style.left = '';
                draggedItem.style.top = '';
                draggedItem.style.opacity = '1';
                draggedItem.style.width = ''; 
                draggedItem.style.height = '';

                if (currentDropZone) {
                    currentDropZone.classList.remove('drop-zone-active');
                    handleDrop(draggedItem, currentDropZone);
                } else {
                    originalParent.appendChild(draggedItem);
                }
                draggedItem = null;
                currentDropZone = null;
                originalParent = null;
            });
        }

        revealBtn.addEventListener('click', checkAnswers);
        nextBtn.addEventListener('click', loadNextQuestion);
        fullscreenBtn.addEventListener('click', toggleFullScreen);
    </script>
</body>
</html>
